

Using the Zhou et al hdWGCNA analysis from Figure 1 of the paper, we need to
evaluate the performance of hdWGCNA

```{r eval=FALSE}


library(Seurat)
library(tidyverse)
library(cowplot)
library(patchwork)
library(WGCNA)

library(Matrix)
library(viridis)
library(harmony)
library(RColorBrewer)
library(ggpubr)
library(tictoc)
library(RColorBrewer)
library(Hmisc)
library(corrplot)
library(enrichR)
library(GeneOverlap)
library(grid)
library(gridExtra)
library(igraph)
library(ggrepel)
library(hdWGCNA)
library(magrittr)
enableWGCNAThreads(nThreads = 8)
theme_set(theme_cowplot())
set.seed(12345)


# spatial plotting functions
source('/dfs7/swaruplab/smorabit/analysis/scWGCNA/bin/spatial_functions.R')

#devtools::install_github('smorabit/hdWGCNA', ref='dev')
#library(hdWGCNA)

setwd('/dfs7/swaruplab/smorabit/analysis/scWGCNA/')

# output directories
data_dir <- "data/"
fig_dir <- 'figures/'

# re-load scWGCNA dataset:
load(file='data/Zhou_color_scheme.rda')


# reload process ed with all cell types
# seurat_obj <-  readRDS(file=paste0(data_dir, 'Zhou_scWGCNA_all_celltypes.rds'))


load('/dfs7/swaruplab/smorabit/analysis/AD_NucSeq_2019/batch_correction/liger/update/celltype-analysis/data/color_scheme.rda')
cp <- unlist(color_scheme_snRNA_celltype)
cp[names(cp) == 'EX'] <- 'turquoise'


setwd('/dfs7/swaruplab/smorabit/analysis/scWGCNA/evaluate')

seurat_obj <- readRDS(file='/dfs7/swaruplab/smorabit/analysis/scWGCNA/brain_iterative/data/Zhou_scWGCNA_all_celltypes.rds')


```

Run EGAD tutorial

https://github.com/sarbal/EGAD

```{r eval=FALSE}

# Load EGAD and the data files
library(EGAD)
data(biogrid)
data(GO.human)

# Or you can load EGADlite here too (https://github.com/sarbal/EGADLite):
# load("EGADlite.RData")
# download the data folder into your directory and run
# load("data/biogrid.RData")
# load("data/GO.human.RData")

# Make your gene list and the network
genelist <- make_genelist(biogrid)
gene_network <- make_gene_network(biogrid,genelist)

# Store your annotation matrix
goterms <- unique(GO.human[,3])
annotations <- make_annotations(GO.human[,c(2,3)],genelist,goterms)

# Run GBA
GO_groups_voted <- run_GBA(gene_network, annotations)

# neighbor voting AUROCs
auc_GO_nv = GO_groups_voted[[1]][,1]
median(auc_GO_nv)

# node degree AUCs
auc_GO_nd = GO_groups_voted[[1]][,3]
median(auc_GO_nd)

length(goterms)
length(genelist)

dim(annotations)

# all the genes and only some of the GO terms
dim(GO_groups_voted[[2]])

df <- data.frame(
  nv_auc = auc_GO_nv,
  nd_auc = auc_GO_nd
)



p1 <- ggplot(df, aes(y = nv_auc, x=1)) +
  geom_violin() +
  geom_boxplot(notch=TRUE, width=0.25, fill='white', outlier.size=0) +
  ylim(c(0,1)) +
  xlab('') + ylab('AUC') +
  ggtitle('Neighbor voting') +
  theme(
    axis.line.y = element_blank(),
    axis.line.x = element_blank(),
    panel.border =element_rect(color='black', fill=NULL, size=1),
    plot.title = element_text(vjust=-0.5, hjust=0.5, face='plain'),
    panel.grid.major.y = element_line(color='lightgrey', size=0.5)
  )


pdf(paste0(fig_dir, 'test_dens_example.pdf'), width=2, height=3)
p1
dev.off()


```

Run EGAD on our data
loop over each cell type

```{r eval=FALSE}

library(EGAD)

groups <- c('ASC', 'EX', 'INH', 'MG', 'OPC', 'ODC')

ensembl <- read.delim('/dfs7/swaruplab/smorabit/resources/ensembl_GO.txt', sep='\t', header=1)

# load the genes file
gene_table <- read.table('/dfs7/swaruplab/shared_lab/cross-disorder/count_matrices/AD_Zhou_2020/C1/counts_unfiltered/genes.tsv')
gene_table$ID <- do.call(rbind, strsplit(gene_table$V1, '[.]'))[,1]


plot_df <- data.frame()
auc_df <- data.frame()
for(cur_group in groups){

  print(cur_group)

  # get network info for this group
  TOM <- GetTOM(seurat_obj, cur_group)
  modules <- GetModules(seurat_obj, cur_group)

  # get a list of unique genes
  genelist <- unique(modules$gene_name)
  genelist <- genelist[(genelist %in% gene_table$V2)]

  # subset TOM to just these genes
  TOM <- TOM[genelist,genelist]

  # get IDs for these genes
  ix <- match(genelist, gene_table$V2)
  gene_ids <- gene_table$ID[ix]

  # rename TOM genes to gene ids
  colnames(TOM) <- gene_ids
  rownames(TOM) <- gene_ids

  # set up annotations
  goterms <- unique(ensembl$GO.term.accession)
  go_table <- ensembl[,c(1,4)] %>% subset(GO.term.accession != '')
  annotations <- make_annotations(go_table, gene_ids, goterms)

  print(dim(annotations))
  length(gene_ids)
  length(goterms)

  # Run GBA
  GO_groups_voted <- run_GBA(TOM, annotations, min=10, max=Inf)

  # neighbor voting AUROCs
  auc_GO_nv = GO_groups_voted[[1]][,1]

  dim(GO_groups_voted[[2]])

  # node degree AUCs
  auc_GO_nd = GO_groups_voted[[1]][,3]

  # multifunctionality
  multifunc_assessment <- calculate_multifunc(annotations)
  auc_mf <- auc_multifunc(annotations, multifunc_assessment[,4])
  df <- data.frame(
    auc = auc_mf,
    annotation = colnames(annotations)
  )
  df$celltype <- cur_group
  auc_df <- rbind(auc_df, df)

  # neighbor voting df
  df <- data.frame(
    nv_auc = auc_GO_nv,
    nd_auc = auc_GO_nd
  )
  df$celltype <- cur_group
  plot_df <- rbind(plot_df, df)

}



auc_df %<>% subset(!is.nan(auc))

write.csv(plot_df, file='data/egad_auc.csv')

auc_df %>% group_by(celltype) %>% summarise(median(auc))


t1 <- subset(auc_df, celltype == 'EX')
t2 <- subset(auc_df, celltype == 'INH')

all.equal(t1$annotation, t2$annotation)
all.equal(t1$auc, t2$auc)

plot_df %>% group_by(celltype) %>% summarise(Mean = median(nv_auc))

subset(plot_df, celltype == 'ASC') %>% .$nv_auc %>% quantile

# annotations <- c(rep(0,10))
# annotations[c(1,3,5)] <- 1
# optimallist <- 10:1
# aurocs_mf <- auc_multifunc(annotations, optimallist)



p1 <- ggplot(plot_df, aes(y = nv_auc, x=reorder(celltype, nv_auc, median), fill=celltype)) +
  geom_violin() +
  geom_boxplot(notch=TRUE, width=0.25, fill='white', outlier.size=0) +
  ylim(c(0,1)) +
  xlab('') + ylab('AUC') +
  scale_fill_manual(values=cp) +
  RotatedAxis() +
  NoLegend() +
  ggtitle('Neighbor voting') +
  theme(
    axis.line.y = element_blank(),
    axis.line.x = element_blank(),
    panel.border =element_rect(color='black', fill=NULL, size=1),
    plot.title = element_text(vjust=-0.5, hjust=0.5, face='plain'),
    panel.grid.major.y = element_line(color='lightgrey', size=0.5)
  )

auc_df$celltype <- factor(
  as.character(auc_df$celltype),
  levels = c('ODC', 'EX', 'OPC', 'ASC', 'MG', 'INH')
)

p2 <- ggplot(auc_df, aes(y = auc, x=celltype, fill=celltype)) +
  geom_violin() +
  geom_boxplot(notch=TRUE, width=0.25, fill='white', outlier.size=0) +
  ylim(c(0,1)) +
  xlab('') + ylab('AUC') +
  scale_fill_manual(values=cp) +
  RotatedAxis() +
  NoLegend() +
  ggtitle('Multifunctionality') +
  theme(
    axis.line.y = element_blank(),
    axis.line.x = element_blank(),
    panel.border = element_rect(color='black', fill=NULL, size=1),
    plot.title = element_text(vjust=-0.5, hjust=0.5, face='plain'),
    panel.grid.major.y = element_line(color='lightgrey', size=0.5)
  )



p3 <- ggplot(plot_df, aes(y = nd_auc, x=reorder(celltype, nd_auc, mean), fill=celltype)) +
  geom_violin() +
  geom_boxplot(notch=TRUE, width=0.25, fill='white', outlier.size=0) +
  ylim(c(0,1)) +
  xlab('') + ylab('AUC') +
  scale_fill_manual(values=cp) +
  RotatedAxis() +
  NoLegend() +
  ggtitle('Node degree') +
  theme(
    axis.line.y = element_blank(),
    axis.line.x = element_blank(),
    panel.border =element_rect(color='black', fill=NULL, size=1),
    plot.title = element_text(vjust=-0.5, hjust=0.5, face='plain'),
    panel.grid.major.y = element_line(color='lightgrey', size=0.5)
  )



# p2 <- ggplot(df, aes(y = nd_auc, x=1)) +
#   geom_violin() +
#   ylim(c(0,1)) +
#   xlab('')



pdf(paste0(fig_dir, 'test_dens2.pdf'), width=3, height=3)
p1
dev.off()

pdf(paste0(fig_dir, 'test_multifunc2.pdf'), width=3, height=3)
p2
dev.off()

pdf(paste0(fig_dir, 'test_degree2.pdf'), width=3, height=3)
p3
dev.off()


```

Testing code for tracking runtime and memory of different functions

1. MetacellsByGroups
2. MetaspotsByGroups
3. ConstructNetwork
4. ModuleEigengenes
5. ModuleConnectivity

```{r eval=FALSE}


seurat_asd <- readRDS(file='/dfs7/swaruplab/smorabit/analysis/scWGCNA/ASD_case_study/data/Velmeshev_2019_hdWGCNA.rds')
table(seurat_asd$cell_type)

seurat_obj <- seurat_asd %>% subset(cell_type %in% c('INH', 'EX'))
seurat_obj$cell_group <- 'Neuron'

library(tictoc)

mem_start <- gc()

sample_sizes <- c(1000, 5000, 10000, 15000, 20000, 25000, 30000, 35000, 40000, 45000, 50000)

runtime_df <- data.frame()
for(n_sample in sample_sizes){

  ################################################################################
  # Setup the data
  ################################################################################
  print(n_sample)

  cells_sample <- sample(colnames(seurat_obj), n_sample)
  seurat_sample <- seurat_obj[,cells_sample]
  print(dim(seurat_sample))

  seurat_sample <- SetupForWGCNA(
    seurat_sample,
    gene_select = "fraction",
    fraction = 0.05,
    wgcna_name = 'test'
  )

  ################################################################################
  # MetaceLlsByGroups
  ################################################################################
  print('MetacellsByGroups')

  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_sample <- MetacellsByGroups(
    seurat_sample,
    group.by = c("cell_group", "Sample"),
    k = 10,
    max_shared = 5,
    reduction = 'harmony',
    ident.group = 'cell_group',
    min_cells = 20
  )
  mcell_time <- toc()
  mcell_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt


  ################################################################################
  # SetDatExpr & TestSoftPowers (not timed)
  ################################################################################
  print('SetDatExpr')

  seurat_sample <- NormalizeMetacells(seurat_sample)

  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_sample <- SetDatExpr(
    seurat_sample,
    group.by='cell_group',
    group_name = unique(seurat_sample$cell_group),
    use_metacells=TRUE,
    slot = 'data',
    assay = 'RNA'
  )
  sd_time <- toc()
  sd_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt

  print('TestSoftPowers')
  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_sample <- TestSoftPowers(seurat_sample, setDatExpr = FALSE)
  tsp_time <- toc()
  tsp_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt


  ################################################################################
  # ConstructNetwork
  ################################################################################
  print('ConstructNetwork')

  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_sample <- ConstructNetwork(
    seurat_sample,
    setDatExpr=FALSE,
    tom_name = paste0('test', n_sample),
    overwrite_tom=TRUE
  )
  cn_time <- toc()
  cn_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt



  ################################################################################
  # ModuleEigengenes with harmony
  ################################################################################
  print('ModuleEigengenes + harmony')

  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_sample <- ModuleEigengenes(
    seurat_sample,
    group.by.vars="Sample"
  )
  meh_time <- toc()
  meh_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt

  ################################################################################
  # ModuleEigengenes
  ################################################################################
  print('ModuleEigengenes')

  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_sample <- ModuleEigengenes(seurat_sample)
  me_time <- toc()
  me_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt

  ################################################################################
  # ModuleConnectivity
  ################################################################################
  print('ModuleConnectivity')

  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_sample <- ModuleConnectivity(
    seurat_sample,
    group.by='cell_group',
    group_name = as.character(unique(seurat_sample$cell_group))
  )
  mc_time <- toc()
  mc_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt



  ################################################################################
  # Consolidate runtime information
  ################################################################################

  modules <- GetModules(seurat_sample)
  n_mods <- length(unique(modules$module))

  run_df <- data.frame(
    'func' = c('MetacellsByGroups', 'SetDatExpr', 'TestSoftPowers', 'ConstructNetwork', 'ModuleEigengenes', 'ModuleEigengenesHarmony', 'ModuleConnectivity'),
    'runtime' = c(
      as.numeric(mcell_time$toc - mcell_time$tic),
      as.numeric(sd_time$toc - sd_time$tic),
      as.numeric(tsp_time$toc - tsp_time$tic),
      as.numeric(cn_time$toc - cn_time$tic),
      as.numeric(me_time$toc - me_time$tic),
      as.numeric(meh_time$toc - meh_time$tic),
      as.numeric(mc_time$toc - mc_time$tic)
    ),
    'memory' = c(
      mcell_mem, sd_mem, tsp_mem, cn_mem, me_mem, meh_mem, mc_mem
    )
  )
  # run_df$memstr <- R.utils::hsize(run_df$memory)
  run_df$sample <- n_sample

  runtime_df <- rbind(runtime_df, run_df)

  rm(seurat_sample)
  gc()

}

write.csv(runtime_df, file='data/runtime_summary3.csv')

################################################################################
# Plot runtime results
################################################################################


rdf2 <- read.csv('data/runtime_summary2.csv')
rdf3 <- read.csv('data/runtime_summary3.csv')

runtime_df <- rbind(
  subset(rdf2, func != 'ModuleConnectivity'),
  subset(rdf3, func %in% c('ModuleConnectivity', 'TestSoftPowers'))
)
runtime_df <- runtime_df[,-1]


# memory size of object
# test <- GetMEs(seurat_sample)
# object.size(GetMEs(seurat_sample)) / 1024 / 1024

# set factor levels for function
runtime_df$func <- ifelse(
  as.character(runtime_df$func) == 'ModuleEigengenesHarmony',
  'ME + Harmony',
  as.character(runtime_df$func)
)

# compute totals
total_df <- runtime_df %>% group_by(sample) %>% summarise(runtime = sum(runtime), memory = sum(memory))
total_df$memstr <- R.utils::hsize(total_df$memory)
total_df$func <- 'Total'
total_df <- total_df[,colnames(runtime_df)]
runtime_df <- rbind(runtime_df, total_df)

runtime_df$func <- factor(
  as.character(runtime_df$func),
  levels = c('MetacellsByGroups', 'SetDatExpr', 'TestSoftPowers', 'ConstructNetwork', 'ModuleEigengenes', 'ME + Harmony', 'ModuleConnectivity', 'Total'),
)

runtime_df <- subset(runtime_df, !(func %in% c('Total', 'SetDatExpr'))) %>% mutate(func = droplevels(func))


p <- ggplot(runtime_df, aes(x=sample, y=memory/1024)) +
  geom_point(color = 'darkgoldenrod3') +
  geom_line(color = 'darkgoldenrod3') +
  #geom_smooth(method = 'lm') +
  RotatedAxis() +
  ylab('Memory upper bound (Gb)') +
  xlab(expression(N[cells])) +
  # scale_x_continuous(label=comma) +
  theme(
    panel.grid.major =element_line(color='lightgrey', size=0.5),
    panel.border = element_rect(size=1, fill=NA, color='black'),
    axis.line.x = element_blank(),
    axis.line.y = element_blank(),
    strip.text.x = element_text(size=9)
  )

pdf(paste0(fig_dir, 'test_memory4.pdf'), width=5.5, height=3)
p + facet_wrap(~func, ncol=3)
# p + facet_wrap(~func, ncol=4, scales='free_y')
dev.off()


p <- ggplot(runtime_df, aes(x=sample, y=runtime / 60)) +
  geom_point(color='hotpink3') +
  geom_line(color='hotpink3') +
  RotatedAxis() +
  ylab('Runtime (minutes)') +
  xlab(expression(N[cells])) +
  #scale_x_continuous(label=comma) +
  theme(
    panel.grid.major =element_line(color='lightgrey', size=0.5),
    panel.border = element_rect(size=1, fill=NA, color='black'),
    axis.line.x = element_blank(),
    axis.line.y = element_blank(),
    strip.text.x = element_text(size=9)
  )

pdf(paste0(fig_dir, 'test_runtime4.pdf'), width=5.5, height=3)
# p + facet_wrap(~func, ncol=4, scales='free_y')
p + facet_wrap(~func, ncol=3, scales='free_y')
dev.off()


#########################################################
# Plot the old vs new module connectivity 
#######################################################


rdf2 <- read.csv('data/runtime_summary2.csv')
rdf3 <- read.csv('data/runtime_summary3.csv')

runtime_df <- rbind(
  subset(rdf2, func == 'ModuleConnectivity') %>% mutate(version = 'old'),
  subset(rdf3, func == 'ModuleConnectivity') %>% mutate(version = 'new')
)
runtime_df <- runtime_df[,-1]


p1 <- ggplot(runtime_df, aes(x=sample, y=memory/1024, color = version)) +
  geom_point() +
  geom_line() +
  #geom_smooth(method = 'lm') +
  RotatedAxis() +
  ylab('Memory (Gb)') +
  xlab(expression(N[cells])) +
  # scale_x_continuous(label=comma) +
  theme(
    panel.grid.major =element_line(color='lightgrey', size=0.5),
    panel.border = element_rect(size=1, fill=NA, color='black'),
    axis.line.x = element_blank(),
    axis.line.y = element_blank(),
    strip.text.x = element_text(size=9)
  )

p2 <- ggplot(runtime_df, aes(x=sample, y=runtime / 60, color=version)) +
  geom_point() +
  geom_line() +
  RotatedAxis() +
  ylab('Runtime (minutes)') +
  xlab(expression(N[cells])) +
  #scale_x_continuous(label=comma) +
  theme(
    panel.grid.major =element_line(color='lightgrey', size=0.5),
    panel.border = element_rect(size=1, fill=NA, color='black'),
    axis.line.x = element_blank(),
    axis.line.y = element_blank(),
    strip.text.x = element_text(size=9)
  )

pdf(paste0(fig_dir, 'test_moduleconnectivity_compare.pdf'), width=5.5, height=3)
# p + facet_wrap(~func, ncol=4, scales='free_y')
(p1 | p2) + plot_layout(guides='collect')
dev.off()





```

Additional tests:

1. Test the runtime of MetacellsByGroups changing the number of target metacells
2. Runtime of ModuleConnectivity with downsampling
   1. RRHO or spearman correlation of the resulting kMEs
3. Runtime of ConstructNetwork with different numbers of genes as input

```{r eval=FALSE}

################################################################################
# Test Metacells
################################################################################

target_metacells <- c(50, 100, 200, 500, 1000)

mcell_run_df <- data.frame()

for(cur_target in target_metacells){
  print(cur_target)
  tt <- sum(.Internal(gc(FALSE, TRUE, TRUE))[13:14])
  tic()
  seurat_obj <- MetacellsByGroups(
    seurat_obj,
    group.by = c("cell_type", "Sample"),
    k = 25,
    max_shared = 12,
    reduction = 'harmony',
    ident.group = 'cell_type',
    min_cells = 50,
    target_metacells = cur_target
  )
  mcell_time <- toc()
  mcell_mem <- sum(.Internal(gc(FALSE, FALSE, TRUE))[13:14]) - tt


  cur_run_df <- data.frame(
    'runtime' = as.numeric(mcell_time$toc - mcell_time$tic),
    'memory' = mcell_mem,
    'target' = cur_target,
    'n_metacells' = ncol(GetMetacellObject(seurat_obj))
  )

  mcell_run_df <- rbind(mcell_run_df, cur_run_df)

  seurat_obj <- SetMetacellObject(seurat_obj, NULL)
  gc()

}




write.csv(mcell_run_df, file='data/mcell_runtime_summary.csv')

################################################################################
# Plot runtime results
################################################################################

p <- ggplot(mcell_run_df, aes(x=target, y=memory/1024)) +
  geom_point() +
  geom_line() +
  RotatedAxis() +
  ylab('Memory upper bound (Gb)') +
  xlab(expression(N[target])) +
  scale_x_continuous(label=comma) +
  theme(
    panel.grid.major =element_line(color='lightgrey', size=0.5),
    panel.border = element_rect(size=1, fill=NA, color='black'),
    axis.line.x = element_blank(),
    axis.line.y = element_blank(),
    strip.text.x = element_text(size=9)
  )

pdf(paste0(fig_dir, 'test_memory_mcell.pdf'), width=2.5, height=3)
p
# p + facet_wrap(~func, ncol=4, scales='free_y')
dev.off()



p <- ggplot(mcell_run_df, aes(x=target, y=runtime / 60)) +
  geom_point() +
  geom_line() +
  RotatedAxis() +
  ylab('Runtime (minutes)') +
  xlab(expression(N[target])) +
  scale_x_continuous(label=comma) +
  theme(
    panel.grid.major =element_line(color='lightgrey', size=0.5),
    panel.border = element_rect(size=1, fill=NA, color='black'),
    axis.line.x = element_blank(),
    axis.line.y = element_blank(),
    strip.text.x = element_text(size=9),
    axis.title.y = element_blank()
  )

pdf(paste0(fig_dir, 'test_runtime_mcell.pdf'), width=2.5, height=2)
# p + facet_wrap(~func, ncol=4, scales='free_y')
p
dev.off()


```
